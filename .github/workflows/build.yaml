name: build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v0.1.0)'
        required: true
        type: string

env:
  IS_STABLE: ${{ !contains(github.event.inputs.tag, '-') }}
  PRIVATE_REPO: q42602736/Xboard-Mihomo_sub

jobs:
  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            arch: amd64
          - platform: windows
            os: windows-11-arm
            arch: arm64

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Clone private repo
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git clone git@github.com:${{ env.PRIVATE_REPO }}.git source
          cd source
          git checkout ${{ github.event.inputs.tag }} || git checkout main
          git submodule update --init --recursive

      - name: Setup Windows Build Environment
        shell: bash
        run: |
          # 创建持久化工具目录
          TOOLS_DIR="/c/runner-tools"
          mkdir -p "$TOOLS_DIR"

          # 检查并安装jq
          if command -v jq &> /dev/null; then
            echo "✓ jq already available"
          else
            echo "Installing jq..."
            choco install jq -y --no-progress || true
            export PATH="/c/ProgramData/chocolatey/bin:$PATH"
            echo "/c/ProgramData/chocolatey/bin" >> $GITHUB_PATH
          fi

          # 检查并安装Rust/Cargo
          if ! command -v cargo &> /dev/null; then
            echo "Installing Rust..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env"
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          else
            echo "✓ Rust/Cargo already available"
          fi
          cargo --version

          # 检查并安装Inno Setup
          INNO_SETUP_PATH="/c/Program Files (x86)/Inno Setup 6/ISCC.exe"
          if [ -f "$INNO_SETUP_PATH" ]; then
            echo "✓ Inno Setup already available"
          else
            echo "Installing Inno Setup..."
            choco install innosetup -y --no-progress
            echo "/c/Program Files (x86)/Inno Setup 6" >> $GITHUB_PATH
          fi

      - name: Setup rust (ARM only)
        if: matrix.arch == 'arm64'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/aarch64" -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain stable
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          Add-Content $env:GITHUB_PATH $cargoPath

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache-dependency-path: source/core/go.sum

      - name: Setup Flutter (x64)
        if: matrix.arch == 'amd64'
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Setup Flutter (ARM64)
        if: matrix.arch == 'arm64'
        shell: pwsh
        run: |
          git clone https://github.com/flutter/flutter.git -b master C:\flutter
          Add-Content $env:GITHUB_PATH "C:\flutter\bin"
          C:\flutter\bin\flutter --version

      - name: Get Flutter Dependency
        run: |
          cd source
          flutter pub get

      - name: Generate SDK Code
        run: |
          cd source/lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs

      - name: Generate Main Project Code
        run: |
          cd source
          dart run build_runner build --delete-conflicting-outputs

      - name: Prepare Windows Build Environment
        shell: bash
        run: |
          # 确保PATH包含Pub Cache bin和Inno Setup
          PUB_CACHE_BIN="/c/Users/$(whoami)/AppData/Local/Pub/Cache/bin"
          INNO_SETUP_DIR="/c/Program Files (x86)/Inno Setup 6"
          export PATH="$PUB_CACHE_BIN:$INNO_SETUP_DIR:$PATH"
          echo "$PUB_CACHE_BIN" >> $GITHUB_PATH
          echo "$INNO_SETUP_DIR" >> $GITHUB_PATH

          # 安装 flutter_distributor
          dart pub global activate flutter_distributor
          echo "✓ flutter_distributor installed"

      - name: Build
        run: |
          cd source
          dart setup.dart ${{ matrix.platform }} ${{ matrix.arch && format('--arch {0}', matrix.arch) }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}

      - name: List dist contents
        run: |
          echo "=== source/dist contents ==="
          ls -la ./source/dist/ || echo "source/dist not found"
          find ./source/dist -type f 2>/dev/null || echo "No files found"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) }}
          path: ./source/dist
          overwrite: true

  upload:
    runs-on: ubuntu-latest
    needs: [ build ]
    if: ${{ always() && !cancelled() }}
    permissions:
      contents: write
    steps:
      - name: Download
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: Check artifacts
        id: check
        run: |
          if [ -d "./dist" ] && [ "$(ls -A ./dist 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "Found artifacts:"
            ls -la ./dist/
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "No artifacts found"
          fi

      - name: Generate sha256
        if: steps.check.outputs.has_artifacts == 'true'
        run: |
          cd ./dist
          for file in $(find . -type f -not -name "*.sha256"); do
            sha256sum "$file" > "${file}.sha256"
          done

      - name: Release
        if: steps.check.outputs.has_artifacts == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: ./dist/*
          body: "Build for ${{ github.event.inputs.tag }}"
