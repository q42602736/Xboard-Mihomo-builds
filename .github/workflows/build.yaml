name: build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v0.1.0)'
        required: true
        type: string
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - windows
          - android
          - macos
          - macos-arm64
          - macos-amd64

env:
  IS_STABLE: ${{ !contains(github.event.inputs.tag, '-') }}
  PRIVATE_REPO: q42602736/Xboard-Mihomo_sub

jobs:
  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: Windows-2022
            arch: amd64
          - platform: android
            os: ubuntu-latest
            # ä¸æŒ‡å®šarchï¼Œè‡ªåŠ¨æž„å»ºæ‰€æœ‰3ä¸ªæž¶æž„: armeabi-v7a, arm64-v8a, x86_64
          - platform: macos
            os: macos-latest
            arch: arm64
          - platform: macos
            os: macos-15-intel
            arch: amd64

    steps:
      - name: Check if platform should run
        id: check
        run: |
          SELECTED="${{ github.event.inputs.platform }}"
          CURRENT="${{ matrix.platform }}"
          ARCH="${{ matrix.arch }}"
          
          echo "Selected platform: $SELECTED"
          echo "Current matrix: platform=$CURRENT, arch=$ARCH"
          
          SHOULD_RUN="false"
          
          if [ "$SELECTED" = "all" ]; then
            SHOULD_RUN="true"
          elif [ "$SELECTED" = "$CURRENT" ]; then
            SHOULD_RUN="true"
          elif [ "$SELECTED" = "macos-arm64" ] && [ "$CURRENT" = "macos" ] && [ "$ARCH" = "arm64" ]; then
            SHOULD_RUN="true"
          elif [ "$SELECTED" = "macos-amd64" ] && [ "$CURRENT" = "macos" ] && [ "$ARCH" = "amd64" ]; then
            SHOULD_RUN="true"
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          
          if [ "$SHOULD_RUN" = "false" ]; then
            echo "â­ï¸ Skipping $CURRENT ($ARCH) - not selected"
          else
            echo "âœ… Building $CURRENT ($ARCH)"
          fi

      - name: Free Disk Space (Android)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'android'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false  # ä¿ç•™Android SDK
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Additional Disk Cleanup (Android)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'android'
        run: |
          echo "=== é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´ ==="
          df -h

          # æ¸…ç†Android SDKä¸éœ€è¦çš„éƒ¨åˆ†ï¼ˆä¿ç•™NDKï¼Œæž„å»ºéœ€è¦ï¼‰
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/3[0-3]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-3[0-3]
          sudo rm -rf /usr/local/lib/android/sdk/system-images
          sudo rm -rf /usr/local/lib/android/sdk/emulator

          echo ""
          echo "æ¸…ç†åŽç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: Setup SSH
        if: steps.check.outputs.should_run == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Clone private repo
        if: steps.check.outputs.should_run == 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git clone git@github.com:${{ env.PRIVATE_REPO }}.git source
          cd source
          git checkout ${{ github.event.inputs.tag }} || git checkout main
          git submodule update --init --recursive

      - name: Setup Android Signing
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'android'
        run: |
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > source/android/app/keystore.jks
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> source/android/local.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> source/android/local.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> source/android/local.properties

      - name: Setup Windows Build Environment
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'windows'
        shell: bash
        run: |
          # åˆ›å»ºæŒä¹…åŒ–å·¥å…·ç›®å½•
          TOOLS_DIR="/c/runner-tools"
          mkdir -p "$TOOLS_DIR"

          # æ£€æŸ¥å¹¶å®‰è£…jq
          if command -v jq &> /dev/null; then
            echo "âœ“ jq already available"
          else
            echo "Installing jq..."
            choco install jq -y --no-progress || true
            export PATH="/c/ProgramData/chocolatey/bin:$PATH"
            echo "/c/ProgramData/chocolatey/bin" >> $GITHUB_PATH
          fi

          # æ£€æŸ¥å¹¶å®‰è£…Inno Setup
          INNO_SETUP_PATH="/c/Program Files (x86)/Inno Setup 6/ISCC.exe"
          if [ -f "$INNO_SETUP_PATH" ]; then
            echo "âœ“ Inno Setup already available"
          else
            echo "Installing Inno Setup..."
            choco install innosetup -y --no-progress
            echo "/c/Program Files (x86)/Inno Setup 6" >> $GITHUB_PATH
          fi

          # è®¾ç½® CMake å‚æ•°ä»¥å¿½ç•¥ CMP0175 ç­–ç•¥è­¦å‘Š
          # ä¿®å¤ flutter_inappwebview_windows æ’ä»¶ä¸Žæ–°ç‰ˆ CMake çš„å…¼å®¹æ€§é—®é¢˜
          echo "CMAKE_ARGS=-Wno-dev" >> $GITHUB_ENV
          echo "âœ“ CMake configured to ignore policy warnings"

      - name: Setup Rust (x64)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'windows' && matrix.arch == 'amd64'
        shell: bash
        run: |
          if ! command -v cargo &> /dev/null; then
            echo "Installing Rust for x64..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env"
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          else
            echo "âœ“ Rust/Cargo already available"
          fi
          cargo --version

      - name: Setup Go
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache-dependency-path: source/core/go.sum

      - name: Setup Flutter (Windows x64)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'windows' && matrix.arch == 'amd64'
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.35.7"
          cache: true

      - name: Setup Flutter (Android)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'android'
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.35.7"
          cache: true

      - name: Setup Flutter (macOS)
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'macos'
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.35.7"
          cache: true

      - name: Get Flutter Dependency
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source
          flutter pub get

      - name: Generate Executable Names
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source
          echo "=== Generating Executable Names ==="
          dart run scripts/generate_executable_names.dart
          echo ""
          echo "=== Generated Executable Names ==="
          cat lib/generated/executable_names.dart

      - name: Generate SDK Code
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source/lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs

      - name: Generate Main Project Code
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source
          dart run build_runner build --delete-conflicting-outputs

      - name: Generate XBoard Config
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source
          echo "=== Generating XBoard Config ==="
          dart run tools/generate_config.dart
          echo ""
          echo "=== Generated Config ==="
          cat lib/xboard/config/core/generated_config.dart
          echo ""
          echo "=== Pubspec Assets Check ==="
          grep -A 10 "assets:" pubspec.yaml || echo "No assets section found"

      - name: Prepare Windows Build Environment
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'windows'
        shell: bash
        run: |
          # ç¡®ä¿PATHåŒ…å«Pub Cache binå’ŒInno Setup
          PUB_CACHE_BIN="/c/Users/$(whoami)/AppData/Local/Pub/Cache/bin"
          INNO_SETUP_DIR="/c/Program Files (x86)/Inno Setup 6"
          export PATH="$PUB_CACHE_BIN:$INNO_SETUP_DIR:$PATH"
          echo "$PUB_CACHE_BIN" >> $GITHUB_PATH
          echo "$INNO_SETUP_DIR" >> $GITHUB_PATH

          # å®‰è£… flutter_distributor
          dart pub global activate flutter_distributor
          echo "âœ“ flutter_distributor installed"

      - name: Clean Windows Build Cache
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'windows'
        shell: bash
        run: |
          echo "ðŸ§¹ æ¸…ç† Windows æž„å»ºç¼“å­˜ï¼ˆè§£å†³ CMake å®‰è£…é—®é¢˜ï¼‰..."
          cd source
          # åˆ é™¤ build/windows ç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰ï¼Œç¡®ä¿å¹²å‡€æž„å»º
          rm -rf build/windows
          # è®¾ç½® CMake ç­–ç•¥çŽ¯å¢ƒå˜é‡ï¼Œè§£å†³ flutter_inappwebview_windows æ’ä»¶å…¼å®¹æ€§é—®é¢˜
          echo "CMAKE_POLICY_DEFAULT_CMP0175=OLD" >> $GITHUB_ENV
          # å¿½ç•¥ CMake å¼€å‘è€…è­¦å‘Š
          echo "CMAKE_NO_WARN_DEV=ON" >> $GITHUB_ENV
          echo "âœ“ æž„å»ºç¼“å­˜å·²æ¸…ç†ï¼ŒCMake ç­–ç•¥å·²é…ç½®"

      - name: Prepare Android Build Environment
        if: steps.check.outputs.should_run == 'true' && matrix.platform == 'android'
        run: |
          echo "Preparing Android build environment..."
          # å®‰è£… flutter_distributor
          dart pub global activate flutter_distributor
          echo "âœ“ flutter_distributor installed"

      - name: Build
        if: steps.check.outputs.should_run == 'true'
        run: |
          cd source
          echo "=== Build Environment ==="
          echo "Platform: ${{ matrix.platform }}"
          echo "Arch: ${{ matrix.arch }}"
          echo "IS_STABLE: ${{ env.IS_STABLE }}"
          echo "Current directory: $(pwd)"
          echo ""
          echo "=== Tool Versions ==="
          which flutter && flutter --version || echo "flutter not found"
          which dart && dart --version || echo "dart not found"
          which cargo && cargo --version || echo "cargo not found"
          which go && go version || echo "go not found"
          echo ""

          if [ "${{ matrix.platform }}" = "windows" ]; then
            echo "=== Windows Build Tools ==="
            which cmake && cmake --version || echo "cmake not found"
            which msbuild && msbuild -version || echo "msbuild not found"
            echo "Visual Studio installations:"
            ls -la "/c/Program Files/Microsoft Visual Studio/" 2>/dev/null || echo "VS not found"
            ls -la "/c/Program Files (x86)/Microsoft Visual Studio/" 2>/dev/null || echo "VS x86 not found"
            echo ""
          fi

          echo "=== Checking flutter_distributor ==="
          which flutter_distributor || echo "flutter_distributor not in PATH"
          flutter_distributor --version || echo "flutter_distributor version failed"
          echo ""
          echo "=== Checking ISCC (Inno Setup) ==="
          which ISCC || echo "ISCC not in PATH"
          ls -la "/c/Program Files (x86)/Inno Setup 6/" 2>/dev/null || echo "Inno Setup dir not found"
          echo ""
          echo "=== Build Command ==="
          echo "Running: dart setup.dart ${{ matrix.platform }} ${{ matrix.arch && format('--arch {0}', matrix.arch) }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }} --version ${{ github.event.inputs.tag }}"
          echo ""
          echo "=== Build Output ==="
          dart setup.dart ${{ matrix.platform }} ${{ matrix.arch && format('--arch {0}', matrix.arch) }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }} --version ${{ github.event.inputs.tag }} 2>&1 | tee build.log
          BUILD_EXIT_CODE=$?
          echo ""
          echo "=== Build Exit Code: $BUILD_EXIT_CODE ==="

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== BUILD FAILED - Collecting Debug Information ==="
            echo ""
            if [ "${{ matrix.platform }}" = "windows" ]; then
              echo "=== CMake Error Logs ==="
              find ./build/windows -name "CMakeError.log" -exec echo "File: {}" \; -exec cat {} \; 2>/dev/null || echo "No CMakeError.log found"
              echo ""

              echo "=== CMake Output Logs ==="
              find ./build/windows -name "CMakeOutput.log" -exec echo "File: {}" \; -exec tail -100 {} \; 2>/dev/null || echo "No CMakeOutput.log found"
              echo ""

              echo "=== MSBuild Error Details ==="
              find ./build/windows -name "*.log" -exec echo "File: {}" \; -exec tail -50 {} \; 2>/dev/null || echo "No MSBuild logs found"
              echo ""

              echo "=== Flutter Build Verbose Output (last 200 lines) ==="
              tail -200 build.log 2>/dev/null || echo "No build log"
              echo ""

              echo "=== Windows Build Directory Structure ==="
              ls -laR ./build/windows/ 2>/dev/null | head -100 || echo "No build directory"
              echo ""
            fi

            echo "=== Full Build Log (last 300 lines) ==="
            tail -300 build.log 2>/dev/null || echo "No build log"

            exit $BUILD_EXIT_CODE
          fi

      - name: List dist contents
        if: always() && steps.check.outputs.should_run == 'true'
        run: |
          echo "=== source/dist contents ==="
          ls -la ./source/dist/ 2>/dev/null || echo "source/dist not found or empty"
          find ./source/dist -type f 2>/dev/null || echo "No files in dist"
          echo ""

          if [ "${{ matrix.platform }}" = "windows" ]; then
            echo "=== source/build/windows contents ==="
            ls -la ./source/build/windows/ 2>/dev/null || echo "source/build/windows not found"
            echo ""
            echo "=== All exe files in source ==="
            find ./source -name "*.exe" -type f 2>/dev/null | grep -v "build/windows/x64/CMakeFiles" | head -30 || echo "No exe files"
          elif [ "${{ matrix.platform }}" = "android" ]; then
            echo "=== source/build/app/outputs contents ==="
            ls -la ./source/build/app/outputs/ 2>/dev/null || echo "source/build/app/outputs not found"
            echo ""
            echo "=== All APK/AAB files in source ==="
            find ./source -name "*.apk" -o -name "*.aab" 2>/dev/null | head -30 || echo "No APK/AAB files"
          fi

          echo ""
          echo "=== Build log tail ==="
          tail -100 ./source/build.log 2>/dev/null || echo "No build log"

      - name: Upload
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) }}
          path: ./source/dist
          overwrite: true

  # åˆå¹¶æ‰€æœ‰å¹³å°çš„æž„å»ºäº§ç‰©åˆ°ä¸€ä¸ª Artifactï¼ˆæ–¹ä¾¿ä¸‹è½½ï¼‰
  merge-artifacts:
    runs-on: ubuntu-latest
    needs: [ build ]
    if: ${{ always() && !cancelled() }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: Check artifacts
        id: check
        run: |
          if [ -d "./dist" ] && [ "$(ls -A ./dist 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "Found artifacts:"
            ls -la ./dist/
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "No artifacts found"
          fi

      - name: Generate sha256
        if: steps.check.outputs.has_artifacts == 'true'
        run: |
          cd ./dist
          for file in $(find . -type f -not -name "*.sha256"); do
            sha256sum "$file" > "${file}.sha256"
          done

      - name: Upload merged artifact
        if: steps.check.outputs.has_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: all-platforms-${{ github.event.inputs.tag }}
          path: ./dist/*
          retention-days: 30
